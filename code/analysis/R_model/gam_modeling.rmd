---
title: "gam_modeling"
author: "darya akimova"
date: "9/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Setup

## Packages:

```{r packages, comment=NA}
library(tidyverse)
library(cowplot)
library(viridis)
library(sf)
library(mgcv)
theme_set(theme_minimal())
```


## Data:

```{r data_import, comment=NA}
death_and_acs_data <- read_csv("../../../data/tidy_data/death_count_norm_to_pop_and_acs_town_demographics_merge.csv")
ma_town_coord <- read_csv("../../../data/tidy_data/ma_town_crs4326_coords.csv")
ma_town_map <- st_read("../../../data/raw_data/townssurvey_shp/TOWNSSURVEY_POLYM.shp")
acs_medicare_opioid_merge <- read_csv("../../../data/tidy_data/acs_medicare_opioid_stats_death_rate.csv")
death_acs_merge_full <- read_csv("../../../data/tidy_data/death_count_norm_to_pop_and_acs_town_demographics_merge_all_cols.csv")
benzo_pres <- read_csv("../../../data/tidy_data/med_partD_benzo_sum_w_town_merge_13_to_17.csv")
```


# EDA and Feature Engineering

## Data structure

```{r data_glimpse, comment=NA}
glimpse(death_and_acs_data)
glimpse(ma_town_coord)
```


## Joining datasets

```{r}
acs_data_w_geospatial <- death_and_acs_data %>% 
  inner_join(ma_town_coord, by = c("city_death" = "town"))
ma_town_map_w_data <- ma_town_map %>% 
  st_transform(crs = "+init=epsg:4326") %>% 
  mutate(TOWN = str_to_lower(TOWN)) %>% 
  left_join(death_and_acs_data, by = c("TOWN" = "city_death"))
```


```{r mapping, comment=NA}
ma_town_map_w_data$death_rate_18_cut <- as.character(cut(ma_town_map_w_data$death_rate_18, breaks = seq(0, 15, 5), include.lowest = TRUE))
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_18_cut), color = "black") +
  scale_fill_viridis_d(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k residents\n2018")
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_17), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k town residents\n2017")
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_16), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k town residents\n2016")
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_15), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k town residents\n2015")
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_14), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k town residents\n2014")
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_13), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k town residents\n2013")
```


# Modeling

## Model

```{r}
acs_medicare_opioid_merge
death_acs_merge_full
```


```{r}
acs_medicare_opioid_merge <- acs_medicare_opioid_merge %>% 
  mutate(id = row_number()) %>% 
  inner_join(ma_town_coord, by = c("city_death" = "town"))
colnames(acs_medicare_opioid_merge)
table(acs_medicare_opioid_merge$year)

colnames(death_acs_merge_full)
yearly_pop <- death_acs_merge_full %>% 
  select(city_death, tot_pop_17, tot_pop_16:tot_pop_13) %>% 
  gather(key="year", value="tot_pop", -city_death) %>% 
  mutate(
    year = case_when(
      year == "tot_pop_17" ~ 2017,
      year == "tot_pop_16" ~ 2016,
      year == "tot_pop_15" ~ 2015,
      year == "tot_pop_14" ~ 2014,
      year == "tot_pop_13" ~ 2013,
      TRUE ~ 0
    )
  )

mod_df_count <- acs_medicare_opioid_merge %>% 
  select(-c(tot_pop_17, over_65_prop, mean_med_inc_desp)) %>% 
  inner_join(yearly_pop, by = c("city_death", "year"))
mod_df_count
yearly_death_count <- death_acs_merge_full %>% 
  select(city_death, `2014`:`2018`) %>% 
  gather(key="year", value="death_count_next_year", -city_death) %>% 
  mutate(year = as.numeric(year) - 1)
yearly_death_count
mod_df_count <- yearly_death_count %>% 
  inner_join(mod_df_count, by = c("city_death", "year"))
mod_df_count
benzo_pres %>% 
  ggplot(aes(sqrt(total_claim_count), sqrt(total_day_supply), color = generic_name)) +
  geom_point(alpha = 0.5, size = 1) +
  facet_wrap(~ year)
benzo_pres %>% 
  ggplot(aes(sqrt(total_claim_count), sqrt(total_30_day_fill_count), color = generic_name)) +
  geom_point(alpha = 0.5, size = 1) +
  facet_wrap(~ year)
benzo_tot_day_supp <- benzo_pres %>% 
  select(town:year, total_day_supply) %>% 
  spread(key = generic_name, value = total_day_supply)
benzo_tot_day_supp %>% 
  ggplot(aes(sqrt(alprazolam), sqrt(diazepam))) +
  geom_point() +
  facet_wrap(~ year)
benzo_tot_day_supp %>% 
  ggplot(aes(sqrt(alprazolam), sqrt(lorazepam))) +
  geom_point() +
  facet_wrap(~ year)
sapply(data.frame(sapply(benzo_tot_day_supp, is.na)), sum)
benzo_tot_day_supp_nona <- benzo_tot_day_supp %>% 
  replace(is.na(.), 0) %>% 
  rename(city_death = town)
sapply(data.frame(sapply(benzo_tot_day_supp_nona, is.na)), sum)
benzo_tot_day_supp_nona %>% 
  ggplot(aes(sqrt(alprazolam), sqrt(diazepam))) +
  geom_point() +
  facet_wrap(~ year)
benzo_tot_day_supp_nona
mod_df_count <- mod_df_count %>% 
  inner_join(benzo_tot_day_supp_nona, by = c("city_death", "year")) %>% 
  mutate(
    alprazolam_per_65_and_over = alprazolam / over_65_count,
    diazepam_per_65_and_over = diazepam / over_65_count,
    lorazepam_per_65_and_over = lorazepam / over_65_count,
    tot_benzo_count = alprazolam + diazepam + lorazepam,
    tot_benzo_per_65_and_over = tot_benzo_count / over_65_count
  )
colnames(mod_df_count)
summary(mod_df_count)
sapply(data.frame(sapply(mod_df_count, is.na)), sum)
```


Alternative test/train split testing, not used

```{r, eval=FALSE}
library(caret)
mod_df_count <- mod_df_count %>% 
  arrange(year, city_death)
mod_df_count %>% 
  count(year)
towns_to_leave <- mod_df_count %>% 
  count(city_death) %>% 
  filter(n >= 5)
mod_df_count <- mod_df_count %>% 
  filter(city_death %in% towns_to_leave$city_death) %>% 
  arrange(year, city_death)

flds <- createTimeSlices(mod_df_count$death_count_next_year, initialWindow = 246, horizon = 2, fixedWindow = TRUE)
names(flds)[1] <- "train"
```




```{r}
test_set <- mod_df_count %>% 
  filter(year == 2017)


mean(mod_df_count$death_count_next_year)
var(mod_df_count$death_count_next_year)

valid_set <- mod_df_count %>% 
  filter(year == 2016)
train_set <- mod_df_count %>% 
  filter(year < 2016)
train_set %>% 
  count(year)
# rmse error calc to evaluate models
rmse <- function(model, df) {
  rmse_error <- (df$death_count_next_year - predict(model, df, type = "response")) ^ 2 %>% 
    mean() %>% 
    sqrt()
  return(rmse_error)
}
# concurvity transform to pull out the worst-case relationships between features
concurvity_df <- function(model) {
  worst_conc_tbl <- concurvity(model, full = FALSE) %>%
    data.frame() %>% 
    rownames_to_column("feature") %>% 
    tbl_df() %>% 
    mutate_if(is.numeric, round, 3) %>% 
    select(feature, contains("worst"))
  return(worst_conc_tbl)
}

base_model <- gam(
  death_count_next_year ~ s(x,y) + s(year, k = 3) + s(tot_pop),
  data = train_set, method = "REML", family = nb()
  )
summary(base_model)
gam.check(base_model)
concurvity(base_model)
qq.gam(base_model, cex = 4)
# error on training
rmse(base_model, train_set)
# error on validation
rmse(base_model, valid_set)

mean(train_set$death_count_next_year)
sd(train_set$death_count_next_year)
mean(valid_set$death_count_next_year)
sd(valid_set$death_count_next_year)
### all features
full_model <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(med_house_inc) + s(mean_house_inc) + s(at_or_below_pov_prop) + s(pop_struggling_prop) + town_status + urb_v_rur + s(opioid_rate_avg) + s(less_than_hs_ed) + s(alprazolam_per_65_and_over) + s(diazepam_per_65_and_over) + s(lorazepam_per_65_and_over) + s(tot_benzo_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model)
gam.check(full_model)
concurvity(full_model)
qq.gam(full_model, cex = 4)
# error on training
rmse(full_model, train_set)
# error on validation
rmse(full_model, valid_set)

full_model_conc <- concurvity_df(full_model)
full_model_conc


full_model_conc <- full_model_conc %>% 
  filter(feature != "para") %>% 
  select(-worst.para) %>% 
  gather(key="feature2", value="value", -feature) %>% 
  ggplot(aes(feature, feature2, fill=value)) +
  geom_raster() +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  ggtitle("Concurvity Plot\nFull Model") +
  xlab("Feature 1") +
  ylab("Feature 2")
full_model_conc
#save_plot(filename = "../../../figures/tidy_figures/full_model_concurvity.png", full_model_conc, base_height = 6, base_width = 8)
train_set_scaled <- train_set %>% 
  select(-c(year:death_count_next_year, x:y)) %>% 
  mutate_if(is.numeric, scale) %>% 
    bind_cols(
      train_set %>% 
        select(year:death_count_next_year, x:y)
    )
colnames(train_set_scaled)
full_model_scaled <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(med_house_inc) + s(mean_house_inc) + s(at_or_below_pov_prop) + s(pop_struggling_prop) + town_status + urb_v_rur + s(opioid_rate_avg) + s(less_than_hs_ed) + s(alprazolam_per_65_and_over) + s(diazepam_per_65_and_over) + s(lorazepam_per_65_and_over) + s(tot_benzo_per_65_and_over),
    data = train_set_scaled, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_scaled)
summary(full_model)
# error on training
rmse(full_model_scaled, train_set_scaled)
# same model


### scaling back
# take out med_house_inc (high concurvity with mean_house_inc) and tot_benzo_per_65_and_over
full_model_sub1 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(mean_house_inc) + s(at_or_below_pov_prop) + s(pop_struggling_prop) + town_status + urb_v_rur + s(opioid_rate_avg) + s(less_than_hs_ed) + s(alprazolam_per_65_and_over) + s(diazepam_per_65_and_over) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub1)
gam.check(full_model_sub1)
concurvity(full_model_sub1)
qq.gam(full_model_sub1, cex = 4)
# error on training
rmse(full_model_sub1, train_set)
# error on validation
rmse(full_model_sub1, valid_set)

### concurvity check
full_model_sub1_conc <- concurvity_df(full_model_sub1)
full_model_sub1_conc


full_model_sub1_conc %>% 
  gather(key="feature2", value="value", -feature) %>% 
  ggplot(aes(feature, feature2, fill=value)) +
  geom_raster() +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  ggtitle("Concurvity plot\nFull Model - sub 1")
full_model_sub1_conc %>% 
  select(feature, contains("per_65_and_over"))
# diazepam is not very predictive (p-val not sig) and has high concurvity with more predictive features

### sub 2 - take out diazepam term
full_model_sub2 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(mean_house_inc) + s(at_or_below_pov_prop) + s(pop_struggling_prop) + town_status + urb_v_rur + s(opioid_rate_avg) + s(less_than_hs_ed) + s(alprazolam_per_65_and_over) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub2)
gam.check(full_model_sub2)
concurvity(full_model_sub2)
qq.gam(full_model_sub2, cex = 4)
# error on training
rmse(full_model_sub2, train_set)
# error on validation
rmse(full_model_sub2, valid_set)

### concurvity check
full_model_sub2_conc <- concurvity_df(full_model_sub2)
full_model_sub2_conc 
full_model_sub2_conc %>% 
  select(feature, contains("below_pov")) %>% 
  arrange(desc(worst.s.at_or_below_pov_prop.))
# remove at or below poverty


full_model_sub3 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(mean_house_inc) + s(pop_struggling_prop) + town_status + urb_v_rur + s(opioid_rate_avg) + s(less_than_hs_ed) + s(alprazolam_per_65_and_over) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub3)
gam.check(full_model_sub3)
concurvity(full_model_sub3)
qq.gam(full_model_sub3, cex = 4)
# error on training
rmse(full_model_sub3, train_set)
# error on validation
rmse(full_model_sub3, valid_set)
  
### concurvity check
full_model_sub3_conc <- concurvity_df(full_model_sub3)
full_model_sub3_conc %>% 
  select(feature, contains("tot_pop")) %>% 
  arrange(desc(worst.s.tot_pop.))
# remove at or below poverty


### take out urban v rural from sub 3 - not informative
full_model_sub4 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(mean_house_inc) + s(pop_struggling_prop) + town_status + s(opioid_rate_avg) + s(less_than_hs_ed) + s(alprazolam_per_65_and_over) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub4)
gam.check(full_model_sub4)
concurvity(full_model_sub4)
qq.gam(full_model_sub4, cex = 4)
# error on training
rmse(full_model_sub4, train_set)
# error on validation
rmse(full_model_sub4, valid_set)

### concurvity check
full_model_sub4_conc <- concurvity_df(full_model_sub4)
full_model_sub4_conc

### test another type of interaction term
full_model_sub5 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(mean_house_inc) + s(pop_struggling_prop) + town_status + s(opioid_rate_avg) + s(less_than_hs_ed) + s(alprazolam_per_65_and_over) + s(lorazepam_per_65_and_over) + ti(x, y, tot_pop, d=c(2, 1)),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub5)
gam.check(full_model_sub5)
concurvity(full_model_sub5)
qq.gam(full_model_sub5, cex = 4)
# error on training
rmse(full_model_sub5, train_set)
# error on validation
rmse(full_model_sub5, valid_set)


### back pedal - take that out and go back to sub 4 - look at interaction between terms
#s(mean_house_inc)   
#s(pop_struggling_prop
train_set %>% 
  ggplot(aes(mean_house_inc, pop_struggling_prop)) +
  geom_point(size = 2, alpha = 0.5)
full_model_sub4_conc %>% 
  select(feature, contains("mean")) %>% 
  arrange(desc(worst.s.mean_house_inc.))
full_model_sub4_conc %>% 
  select(feature, contains("hs")) %>% 
  arrange(desc(worst.s.less_than_hs_ed.))
train_set %>% 
  ggplot(aes(mean_house_inc, less_than_hs_ed)) +
  geom_point(size = 2, alpha = 0.5)
train_set %>% 
  ggplot(aes(pop_struggling_prop, less_than_hs_ed)) +
  geom_point(size = 2, alpha = 0.5)
full_model_sub4_conc %>% 
  select(feature, contains("tot_pop")) %>% 
  arrange(desc(worst.s.tot_pop.))

### sub 4 - less_than_hs_ed
full_model_sub6 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(mean_house_inc) + s(pop_struggling_prop) + town_status + s(opioid_rate_avg) + s(alprazolam_per_65_and_over) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub6)
gam.check(full_model_sub6)
concurvity(full_model_sub6)
qq.gam(full_model_sub6, cex = 4)
# error on training
rmse(full_model_sub6, train_set)
# error on validation
rmse(full_model_sub6, valid_set)

### concurvity check
full_model_sub6_conc <- concurvity_df(full_model_sub6)
full_model_sub6_conc
full_model_sub6_conc %>% 
  gather(key="feature2", value="value", -feature) %>% 
  ggplot(aes(feature, feature2, fill=value)) +
  geom_raster() +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  ggtitle("Concurvity plot\nFull Model - Sub 6")


### try giving higher k to terms
full_model_sub7 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop, k = 12) + s(mean_house_inc, k = 12) + s(pop_struggling_prop, k =12) + town_status + s(opioid_rate_avg) + s(alprazolam_per_65_and_over, k = 12) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub7)
gam.check(full_model_sub7)
concurvity(full_model_sub7)
qq.gam(full_model_sub7, cex = 4)
# error on training
rmse(full_model_sub7, train_set)
# error on validation
rmse(full_model_sub7, valid_set)
rmse(full_model_sub6, valid_set)


# back pedal
full_model_sub6_conc %>% 
  select(feature, contains("mean")) %>% 
  arrange(desc(worst.s.mean_house_inc.))
full_model_sub6_conc %>% 
  select(feature, contains("pop_struggling_prop")) %>% 
  arrange(desc(worst.s.pop_struggling_prop.))
sum(full_model_sub6_conc$worst.s.mean_house_inc.)
sum(full_model_sub6_conc$worst.s.pop_struggling_prop.)
summary(full_model_sub6)

# model 6, but take out alprazolam - does it make a diffrence?
full_model_sub8 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(mean_house_inc) + s(pop_struggling_prop) + town_status + s(opioid_rate_avg) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub8)
gam.check(full_model_sub8)
concurvity(full_model_sub8)
qq.gam(full_model_sub8, cex = 4)
# error on training
rmse(full_model_sub8, train_set)
# error on validation
rmse(full_model_sub8, valid_set)
rmse(full_model_sub6, valid_set)
## taking out alprazolam makes model slightly worse


# model 6- but take out mean house inc - strong relationship with pop struggling and x,y
full_model_sub9 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(pop_struggling_prop) + town_status + s(opioid_rate_avg) + s(alprazolam_per_65_and_over) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub9)
gam.check(full_model_sub9)
concurvity(full_model_sub9)
qq.gam(full_model_sub9, cex = 4)
# error on training
rmse(full_model_sub9, train_set)
# error on validation
rmse(full_model_sub9, valid_set)
rmse(full_model_sub6, valid_set)
# model is a lot worse again

### concurvity check
full_model_sub9_conc <- concurvity_df(full_model_sub9)
full_model_sub9_conc

# try taking out povertyfrom model sub 6 instead?
full_model_sub10 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(mean_house_inc) + town_status + s(opioid_rate_avg) + s(alprazolam_per_65_and_over) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub10)
gam.check(full_model_sub10)
concurvity(full_model_sub10)
qq.gam(full_model_sub10, cex = 4)
# error on training
rmse(full_model_sub10, train_set)
# error on validation
rmse(full_model_sub10, valid_set)
rmse(full_model_sub6, valid_set)

# try raising k again, but on mod 10
full_model_sub11 <- gam(
    death_count_next_year ~ s(x,y, k = 45) + s(year, k=3) + s(tot_pop, k = 15) + s(mean_house_inc, k = 15) + town_status + s(opioid_rate_avg) + s(alprazolam_per_65_and_over, k = 15) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub11)
gam.check(full_model_sub11)
concurvity(full_model_sub11)
qq.gam(full_model_sub11, cex = 4)
# error on training
rmse(full_model_sub11, train_set)
# error on validation
rmse(full_model_sub11, valid_set)
rmse(full_model_sub10, valid_set)

### concurvity check
full_model_sub10_conc <- concurvity_df(full_model_sub10)
full_model_sub10_conc %>% 
  select(feature, contains("per_65")) %>% 
  arrange(desc(worst.s.alprazolam_per_65_and_over.))
full_model_sub11_conc <- concurvity_df(full_model_sub11)
full_model_sub11_conc %>% 
  select(feature, contains("per_65")) %>% 
  arrange(desc(worst.s.alprazolam_per_65_and_over.))

# try rolling back k for x,y and mean house inc
full_model_sub12 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop, k = 15) + s(mean_house_inc) + town_status + s(opioid_rate_avg) + s(alprazolam_per_65_and_over, k = 15) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub12)
gam.check(full_model_sub12)
concurvity(full_model_sub12)
qq.gam(full_model_sub12, cex = 4)
# error on training
rmse(full_model_sub12, train_set)
rmse(full_model_sub10, train_set)
# error on validation
rmse(full_model_sub12, valid_set)
rmse(full_model_sub11, valid_set)
rmse(full_model_sub10, valid_set)

## last shot - try tuning up k for alprazolam
full_model_sub13 <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop, k = 15) + s(mean_house_inc) + town_status + s(opioid_rate_avg) + s(alprazolam_per_65_and_over, k = 18) + s(lorazepam_per_65_and_over),
    data = train_set, method = "REML", family = nb(), select = TRUE
    )
summary(full_model_sub13)
gam.check(full_model_sub13)
concurvity(full_model_sub13)
qq.gam(full_model_sub13, cex = 4)
# error on training
rmse(full_model_sub13, train_set)
rmse(full_model_sub10, train_set)
# error on validation
rmse(full_model_sub13, valid_set)
rmse(full_model_sub12, valid_set)
rmse(full_model_sub11, valid_set)
rmse(full_model_sub10, valid_set)

### higher k doesn't seem to make the model better - go with model 10

train_full <- mod_df_count %>% 
  filter(year < 2017)

final_model <- gam(
    death_count_next_year ~ s(x,y) + s(year, k=3) + s(tot_pop) + s(mean_house_inc) + town_status + s(opioid_rate_avg) + s(alprazolam_per_65_and_over) + s(lorazepam_per_65_and_over),
    data = train_full, method = "REML", family = nb(), select = TRUE
    )
summary(final_model)
gam.check(final_model)
concurvity(final_model)
qq.gam(final_model, cex = 4)
# error on training
rmse(final_model, train_full)
# error on validation
rmse(full_model_sub10, test_set)
rmse(final_model, test_set)
mean(test_set$death_count_next_year)
sd(test_set$death_count_next_year)
test_set$fin_pred <- predict(final_model, test_set, type = "response")
sd(test_set$fin_pred)
mod_df_count$fin_pred <- predict(final_model, mod_df_count, type = "response")



library(mgcViz)
test <- getViz(final_model)
qq(test, rep = 10, method = "simul1", CI = "normal", showReps = TRUE,
        ngr = 1e2, a.replin = list(alpha = 0.1), a.qqpoi = list(shape = 19)) +
  ggtitle("QQ Plot\nNegative binomial GAM") +
  xlab("Theoretical Quantiles") +
  ylab("Deviance Residuals") +
  theme(
    axis.text.x = element_text(size = 20),
    axis.text.y = element_text(size = 20),
    axis.title = element_text(size = 20),
    plot.title = element_text(size = 20)
    )
library(broom)
tidy(final_model)
tidy(final_model, parametric=TRUE)
coef(final_model)
print(plot(test, allTerms = T), pages = 1)
plot(test, allTerms = T, select =7)
plot(final_model)
print(plot(test, allTerms = T, residuals = TRUE), pages = 1)
print(plot(test, allTerms = T, rug = TRUE), pages = 1)
plot(test, allTerms = T, select = 3, rug=T)
print(plot(test, allTerms = T), pages = 1)

plot(final_model, seWithMean = TRUE, rug = TRUE, shift = coef(final_model)[1], select=2)
plot(final_model, select=7, rug=TRUE)


o <- plot( sm(test, 7) )
o + 
 # l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
  l_ciPoly() +
  l_fitLine(colour = "red") +
  #l_ciLine(mul = 5, colour = "blue", linetype = 2) + 
  l_points(shape = 19, size = 1, alpha = 0.1)


ma_town_map_w_data %>% 
  mutate(
    town_status = replace_na(town_status, "unsure"),
    town_status = as_factor(town_status)
  ) %>% 
  ggplot() +
  geom_sf(aes(fill = town_status)) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    panel.grid.major = element_line(colour = 'transparent'),
    legend.text = element_text(size = 20),
    plot.title = element_text(size = 24)
    ) +
  scale_fill_manual(values= c("#f1a340", "#998ec3", "#f7f7f7"), name  = NULL) +
  ggtitle("Town Pop Grown/Shrunk (2010 - 2017)")
ma_town_map_w_data %>% 
  ggplot() +
  geom_sf(aes(fill = log(tot_pop_17 + 1))) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    panel.grid.major = element_line(colour = 'transparent'),
    legend.text = element_text(size = 20),
    plot.title = element_text(size = 24)
    ) +
  scale_fill_viridis_c(option="D", name = NULL) +
  ggtitle("2017 Town Population\nlog scale")
  #scale_fill_manual(values= c("#f1a340", "#998ec3", "#f7f7f7"), name  = NULL)
```


```{r}
mod_df_count

mod_df_count %>% 
  mutate(year = as_factor(year+1)) %>% 
  ggplot(aes(death_count_next_year, fill = year)) +
  geom_histogram(position="dodge", bins=10) +
  scale_fill_brewer(type = "seq", name = "Year", direction = -1) + 
  theme_dark() +
  xlab("Number of Overdose Deaths per Town") +
  ylab("Count") +
  theme(
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    axis.title = element_text(size = 14)
    )
library(ggridges)
mod_df_count %>% 
  mutate(year = fct_rev(as_factor(year+1))) %>% 
  ggplot(aes(death_count_next_year, y = year, fill = year)) +
  geom_density_ridges(stat = "binline", binwidth=5,draw_baseline = F) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_fill_brewer(type = "seq", name = "Year") +
  xlab("Number of opioid overdose deaths per town") +
  ylab("") +
  theme(
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title = element_text(size = 24),
    legend.text = element_text(size = 24),
    legend.title = element_text(size = 24)
    )

mod_df_count %>% 
  filter(year == 2017) %>% 
  mutate(year = fct_rev(as_factor(year+1))) %>% 
  ggplot(aes(death_count_next_year)) +
  geom_histogram(binwidth = 5) +
  xlab("") +
  ylab("") +
  theme(
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    axis.title = element_text(size = 14)
    )


ma_total_deaths <- read_csv("../../../data/tidy_data/ma_total_overdose_for_graph.csv")
ma_total_deaths %>% 
  ggplot(aes(year, overdose_deaths, fill = group)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values=c("grey80", "orange2"), guide=FALSE) +
  ylab("") +
  xlab("Year") +
  ggtitle("Total opioid-related deaths per year\nMassachusetts") +
  theme(
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title = element_text(size = 24),
    plot.title = element_text(size = 24)
    ) +
  scale_x_continuous(breaks=c(2000, 2014, 2018))
ma_total_deaths_for_blog <- ma_total_deaths %>% 
  ggplot(aes(year, overdose_deaths, fill = group)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values=c("grey80", "orange2"), guide=FALSE) +
  ylab("Number of Deaths") +
  xlab("Year") +
  theme(
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    axis.title = element_text(size = 14),
    plot.title = element_text(size = 16)
    ) +
  ggtitle("Total opioid overdose death per year\nMassachusetts") +
  scale_x_continuous(breaks=c(2002, 2006,2010, 2014, 2018))
ma_total_deaths_for_blog
save_plot("./ma_deaths_for_blog.png", ma_total_deaths_for_blog, base_width = 8, base_height=4)
ma_town_centroids <- st_centroid(ma_town_map_w_data)
ma_town_map_w_data %>% 
  ggplot() +
  geom_sf(color = "grey20") +
  geom_sf(data = ma_town_centroids, size = 2, color = "#d95f02") +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    panel.grid.major = element_line(colour = 'transparent')
    )

ma_map_with_towns_and_centroids <- ma_town_map_w_data %>% 
  ggplot() +
  geom_sf(color = "grey20") +
  geom_sf(data = ma_town_centroids, size = 1.5, color = "#d95f02") +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    panel.grid.major = element_line(colour = 'transparent')
    ) +
  ggtitle("Massachusetts municipal (city and town) boundaries\nCentroids overlaid") #+ 
#  theme(
#    plot.title = element_text(size = 16)
#    )

ma_count_map_all_data <- ma_town_map %>% 
  st_transform(crs = "+init=epsg:4326") %>% 
  mutate(TOWN = str_to_lower(TOWN)) %>% 
  left_join(death_acs_merge_full, by = c("TOWN" = "city_death"))


ma_count_map_all_data %>%
  ggplot() +
  geom_sf(aes(fill = `2018`), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Count") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death counts per town\n2018")

ma_count_map_all_data$death_18_cut <- cut(ma_count_map_all_data$`2018`, breaks = c(0, 1, 5, 10, 50, 250), include.lowest = TRUE)
table(ma_count_map_all_data$death_18_cut)
ma_map_2018_count <- ma_count_map_all_data %>%
  ggplot() +
  geom_sf(aes(fill = death_18_cut), color = "gray50") +
  scale_fill_viridis_d(option = "D", name = "Count\nInterval") +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    panel.grid.major = element_line(colour = 'transparent'),
    plot.title = element_text(size = 22),
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 18)
    ) +
  ggtitle("Opioid overdose death counts per town per year\n2018")
ma_map_2018_count 
save_plot(
  filename= "../../../figures/tidy_figures/ma_towns_map_and_deaths_2018.png",
  ma_map_2018_count,
  base_height = 5,
  base_width = 10
  )


death_count_year_hist <- mod_df_count %>% 
  mutate(year = fct_rev(as_factor(year+1))) %>% 
  ggplot(aes(death_count_next_year, y = year, fill = year)) +
  geom_density_ridges(stat = "binline", binwidth=5,draw_baseline = F) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_fill_brewer(type = "seq", name = "Year") +
  xlab("Number of opioid overdose deaths per town") +
  ylab("Year") +
  ggtitle("Opioid overdose death counts distributions")

#save_plot(
#  filename= "./ma_towns_map_and_deaths_for_blog.png",
#  plot_grid(ma_map_with_towns_and_centroids, death_count_year_hist, ncol = 1),
#  base_height = 10,
#  base_width = 8
#  )


mod_df_count %>% 
  mutate(year = year+1) %>% 
  ggplot(aes(death_count_next_year, fin_pred)) +
  geom_point(size=2, alpha=0.5) +
  geom_smooth(method="lm", se=FALSE, size = 1.5) +
  scale_y_sqrt(limits=c(0,300)) +
  scale_x_sqrt(limits=c(0,300)) +
  ylab("Predicted")+
  xlab("Actual") +
  ggtitle("Predicted vs Actual Opioid Overdose Death Counts\nsquare root scale") +
  theme(
    axis.text.x = element_text(size = 20),
    axis.text.y = element_text(size = 20),
    axis.title = element_text(size = 20),
    plot.title = element_text(size = 24)
    )
mod_df_count$resid <- mod_df_count$death_count_next_year - mod_df_count$fin_pred
mod_df_count %>% 
  ggplot(aes(death_count_next_year, resid)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~year) +
  geom_hline(yintercept = 0) +
  scale_x_sqrt() +
  xlab("Overdose death count") +
  ylab("Residual") +
  theme(
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    axis.title = element_text(size = 16),
    strip.text.x = element_text(size=16) 
    )
mod_df_death_rate <- mod_df_count %>% 
  mutate(year=year+1) %>% 
  select(city_death:death_count_next_year, fin_pred, tot_pop) %>% 
  mutate(
    actual_death_rate = death_count_next_year * 10000/ tot_pop,
    pred_death_rate = fin_pred * 10000/ tot_pop,
    town_col = case_when(
      city_death == "ayer" ~ "Ayer",
      city_death == "gardner" ~ "Gardner",
      city_death == "salem" ~ "Salem",
      city_death == "fall river" ~ "Fall River",
      TRUE ~ "Other"
    ),
    town_shape = ifelse(city_death %in% c("ayer", "gardner", "salem", "fall river"), 1.5, 0.5)
  )
mod_df_death_rate %>% 
  ggplot(aes(year, pred_death_rate, group = city_death, color = town_col, size = town_shape)) +
  geom_line(alpha = 1)
mod_df_death_rate %>% 
  ggplot(aes(year, actual_death_rate, group = city_death, color = town_col)) +
  geom_line(alpha = 0.5)
mod_df_death_rate %>% 
  arrange(desc(actual_death_rate))
mod_df_death_rate %>% 
  filter(year == 2018) %>% 
  arrange(desc(pred_death_rate))
mod_df_death_rate_gath <- mod_df_death_rate %>% 
  select(city_death:year, actual_death_rate:pred_death_rate, town_col) %>% 
  gather(key="measure", value="value", actual_death_rate:pred_death_rate) %>% 
  mutate(measure = ifelse(measure=="actual_death_rate", "Actual", "Predicted")) 


mod_df_death_rate_gath %>% 
  filter(town_col == "Other") %>% 
  ggplot(aes(year, value, group = city_death, color = town_col)) +
  geom_line(alpha = 0.5) +
  geom_line(
    data = mod_df_death_rate_gath %>% filter(town_col != "Other"),
    aes(year, value, group = city_death, color = town_col),
    size = 2
    ) +
  facet_wrap(~measure) +
  xlab("Year") +
  ylab("") +
  theme(
    axis.text.x = element_text(size = 20),
    axis.text.y = element_text(size = 20),
    axis.title = element_text(size = 20),
    plot.title = element_text(size = 22),
    strip.text.x = element_text(size = 20),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 20)
    ) +
  ggtitle("Actual v Predicted opioid overdose death rate per town\nRate per 10k town residents") +
  scale_color_manual(values = c("#1b9e77", "#d95f02",  "#7570b3", "grey50","#e7298a"), name = "Towns")

mod_df_death_rate %>% 
  filter(year == 2016) %>% 
  arrange(desc(pred_death_rate))
mod_df_death_rate %>% 
  filter(year == 2018) %>% 
  arrange(desc(pred_death_rate))
```

