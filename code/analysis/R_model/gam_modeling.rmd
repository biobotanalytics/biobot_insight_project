---
title: "gam_modeling"
author: "darya akimova"
date: "9/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

## Packages:

```{r packages, comment=NA}
library(tidyverse)
library(viridis)
library(sf)
library(mgcv)
theme_set(theme_minimal())
```


## Data:

```{r data_import, comment=NA}
death_and_acs_data <- read_csv("../../../data/tidy_data/death_count_norm_to_pop_and_acs_town_demographics_merge.csv")
ma_town_coord <- read_csv("../../../data/tidy_data/ma_town_crs4326_coords.csv")
opi_pres_13 <- read_csv("../../../data/tidy_data/medicare_partD_opioid_prescriber_2013_w_zip_MAtown_v1.csv") %>% 
  select(-1)
opi_pres_14 <- read_csv("../../../data/tidy_data/medicare_partD_opioid_prescriber_2014_w_zip_MAtown_v1.csv") %>% 
  select(-1)
opi_pres_15 <- read_csv("../../../data/tidy_data/medicare_partD_opioid_prescriber_2015_w_zip_MAtown_v1.csv") %>% 
  select(-1)
opi_pres_16 <- read_csv("../../../data/tidy_data/medicare_partD_opioid_prescriber_2016_w_zip_MAtown_v1.csv") %>% 
  select(-1)
opi_pres_17 <- read_csv("../../../data/tidy_data/medicare_partD_opioid_prescriber_2017_w_zip_MAtown_v1.csv") %>% 
  select(-1)
ma_town_map <- st_read("../../../data/raw_data/townssurvey_shp/TOWNSSURVEY_POLYM.shp")
acs_medicare_opioid_merge <- read_csv("../../../data/tidy_data/acs_medicare_opioid_stats_death_rate.csv")
```


# EDA and Feature Engineering

## Data structure

```{r data_glimpse, comment=NA}
glimpse(death_and_acs_data)
glimpse(ma_town_coord)
glimpse(opi_pres_13)
glimpse(opi_pres_14)
glimpse(opi_pres_15)
glimpse(opi_pres_16)
glimpse(opi_pres_17)
```


## Joining datasets

```{r}
acs_data_w_geospatial <- death_and_acs_data %>% 
  inner_join(ma_town_coord, by = c("city_death" = "town"))
ma_town_map_w_data <- ma_town_map %>% 
  st_transform(crs = "+init=epsg:4326") %>% 
  mutate(TOWN = str_to_lower(TOWN)) %>% 
  left_join(death_and_acs_data, by = c("TOWN" = "city_death"))
```


```{r mapping, comment=NA}
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_18), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k town residents\n2018")
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_17), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k town residents\n2017")
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_16), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k town residents\n2016")
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_15), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k town residents\n2015")
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_14), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k town residents\n2014")
ma_town_map_w_data %>%
  ggplot() +
  geom_sf(aes(fill = death_rate_13), color = "black") +
  scale_fill_viridis_c(option = "D", name = "Rate") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  ggtitle("Opioid overdose death rate per 10k town residents\n2013")
```


```{r}
# death rate change calculations:
data_for_mod <- acs_data_w_geospatial %>% 
  mutate(
    diff_18_17 = death_rate_18 - death_rate_17,
    diff_17_16 = death_rate_17 - death_rate_16,
    diff_16_15 = death_rate_16 - death_rate_15,
    diff_15_14 = death_rate_15 - death_rate_14,
    diff_14_13 = death_rate_14 - death_rate_13
  ) %>% 
  select(-c(death_rate_12:death_rate_18)) %>% 
  gather(key = "years_chng", value = "diff", diff_18_17:diff_14_13) %>% 
  mutate(
    year = case_when(
      years_chng == "diff_18_17" ~ 2017,
      years_chng == "diff_17_16" ~ 2016,
      years_chng == "diff_16_15" ~ 2015,
      years_chng == "diff_15_14" ~ 2014,
      years_chng == "diff_14_13" ~ 2013,
    )
  ) %>% 
  select(-years_chng) %>% 
  mutate(id = row_number())
data_for_mod %>% 
  mutate(year = as_factor(year)) %>% 
  ggplot(aes(year, diff, group = year, fill = year)) +
  geom_violin() 
data_for_mod %>% 
  mutate(year = as_factor(year)) %>% 
  ggplot(aes(year, diff, group = year, fill = year)) +
  geom_boxplot() 
data_for_mod %>% 
  mutate(year = as_factor(year)) %>% 
  ggplot(aes(diff, fill = year)) +
  geom_histogram(bins = 50) +
  facet_wrap(~ year)
```


# Modeling


## Test - train split

```{r}
set.seed(2019)
test_set <- data_for_mod %>% 
  sample_frac(0.2, replace = FALSE)
train_set <- data_for_mod %>% 
  filter(!(id %in% (test_set$id)))
```


## Model - only acs and geospatial data

```{r}
# base model with geometry and year only
base_model <- gam(diff ~ s(x, y) + s(year, k=3), data = train_set, method = "REML")
summary(base_model)
mean(abs(train_set$diff - predict(base_model, train_set, type = "response")))
base_model_sel <- gam(diff ~ s(x, y) + s(year, k=3), data = train_set, method = "REML", select = TRUE)
summary(base_model_sel)
coef(base_model_sel)
# mae:
mean(abs(train_set$diff - predict(base_model_sel, train_set, type = "response")))
plot(base_model_sel, residuals = TRUE, pages = 1)
```


```{r}
all_acs_model <- gam(
  diff ~ s(x, y) + year + s(over_65_prop) + s(med_house_inc) + s(mean_house_inc) + s(mean_med_inc_desp) +
    s(drop_out) + s(less_than_hs_ed) + s(at_or_below_pov_prop) + s(pop_struggling_prop) + town_status + urb_v_rur,
  data = train_set, method = "REML", select = TRUE
  )
summary(all_acs_model)
mean(abs(train_set$diff - predict(all_acs_model, train_set, type = "response")), na.rm = TRUE)
train_set$predict_all_mod <- predict(all_acs_model, train_set, type = "response")
train_set %>% 
  ggplot(aes(diff, predict_all_mod)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0)
gam.check(all_acs_model)
concurvity(all_acs_model)
```


```{r}
train_mean_diff <- train_set %>% 
  group_by(city_death) %>% 
  summarise(mean_diff = mean(diff)) %>% 
  inner_join(
    train_set %>% 
      select(-c(diff:predict_all_mod)) %>% 
      distinct(),
    by = "city_death"
  ) %>% 
  mutate(
    town_status = as_factor(town_status),
    urb_v_rur = as_factor(urb_v_rur)
  )
all_acs_mean_model <- gam(
  mean_diff ~ s(x, y) + s(over_65_prop) + s(med_house_inc) + s(mean_house_inc) + s(mean_med_inc_desp) +
    s(drop_out) + s(less_than_hs_ed) + s(at_or_below_pov_prop) + s(pop_struggling_prop) + town_status + urb_v_rur,
  data = train_mean_diff, method = "REML", select = TRUE
  )
summary(all_acs_mean_model)
gam.check(all_acs_mean_model)
concurvity(all_acs_mean_model)
mean(abs(train_mean_diff$mean_diff - predict(all_acs_mean_model, train_mean_diff, type = "response")), na.rm = TRUE)
```












```{r}
acs_medicare_opioid_merge %>% 
  mutate(year = as_factor(year)) %>% 
  ggplot(aes(death_rate_per10k)) +
  geom_histogram() +
  facet_wrap(~year) +
  ggtitle("Death rate for next year (add +1 to year)")
acs_medicare_opioid_merge <- acs_medicare_opioid_merge %>% 
  mutate(id = row_number()) %>% 
  inner_join(ma_town_coord, by = c("city_death" = "town"))
set.seed(2019)
test_set_alt <- acs_medicare_opioid_merge %>% 
  sample_frac(0.2, replace = FALSE)
train_set_alt <- acs_medicare_opioid_merge %>% 
  filter(!(id %in% (test_set_alt$id)))



all_acs_model_alt <- gam(
  death_rate_per10k ~ s(x, y) + year + s(med_house_inc) + s(mean_house_inc) + s(mean_med_inc_desp) + s(drop_out) + s(less_than_hs_ed) + s(at_or_below_pov_prop) + s(pop_struggling_prop) + town_status + urb_v_rur + s(opioid_claim_count_avg) + s(opioid_rate_avg) + s(claim_per_65_and_over) + s(opi_claim_per_65_and_over),
  data = train_set_alt, method = "REML", select = TRUE, family = "poisson"
  )
summary(all_acs_model_alt)


mean(abs(train_set_alt$death_rate_per10k - predict(all_acs_model_alt, train_set_alt, type = "response")), na.rm = TRUE)
plot(train_set_alt$death_rate_per10k,  predict(all_acs_model_alt, train_set_alt, type = "response"))
train_set_alt$mod1_pred <- predict(all_acs_model_alt, train_set_alt, type = "response")

train_set_alt %>% 
  ggplot(aes(death_rate_per10k, mod1_pred)) +
  geom_point(alpha = 0.5, size = 1) +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(~ year)
gam.check(all_acs_model_alt)
concurvity(all_acs_model_alt)
```

